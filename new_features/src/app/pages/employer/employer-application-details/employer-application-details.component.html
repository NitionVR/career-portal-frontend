<div class="py-8 sm:py-12 bg-background">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-5xl">
    <div *ngIf="isLoading" class="flex items-center justify-center py-20">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary"></div>
    </div>

    <div *ngIf="!isLoading && application" class="space-y-8">
      <!-- Header: Candidate Info & Main Actions -->
      <div class="flex flex-col sm:flex-row justify-between items-start gap-6">
        <div class="flex items-center gap-6">
          <div class="relative">
            <ng-container *ngIf="application.candidateProfile?.profileImageUrl; else initialsAvatar">
              <img [src]="application.candidateProfile?.profileImageUrl" alt="Candidate Avatar" class="h-28 w-28 rounded-full ring-4 ring-primary/50">
            </ng-container>
            <ng-template #initialsAvatar>
              <div class="h-28 w-28 rounded-full bg-primary flex items-center justify-center text-primary-foreground font-bold text-5xl">
                {{ application.candidateProfile?.firstName?.charAt(0) }}{{ application.candidateProfile?.lastName?.charAt(0) }}
              </div>
            </ng-template>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-foreground">{{ application.candidateProfile?.firstName }} {{ application.candidateProfile?.lastName }}</h1>
            <p class="text-lg text-muted-foreground">Applied for: <span class="font-semibold text-foreground">{{ application.job?.title }}</span></p>
            <p class="text-sm text-muted-foreground mt-2">Application Date: {{ application.applicationDate | date:'longDate' }}</p>
          </div>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0">
          <button (click)="rejectApplication()" class="px-6 py-2.5 text-sm font-semibold text-foreground bg-muted rounded-full hover:bg-muted/80">Reject</button>
          <button (click)="openAdvanceModal()" class="px-6 py-2.5 text-sm font-semibold text-primary-foreground bg-primary rounded-full hover:bg-primary-hover">Advance to Next Stage</button>
        </div>
      </div>

      <!-- Main Resume Body -->
      <div class="glassmorphism rounded-xl p-8 space-y-10">
        <!-- Professional Summary -->
        <div *ngIf="application.candidateProfile?.profile?.basics?.summary">
          <h2 class="text-2xl font-semibold text-foreground mb-4 border-b border-border pb-2">Professional Summary</h2>
          <p class="text-muted-foreground whitespace-pre-line">{{ application.candidateProfile?.profile?.basics?.summary }}</p>
        </div>

        <!-- Work Experience -->
        <div *ngIf="application.candidateProfile?.profile?.work?.length">
          <h2 class="text-2xl font-semibold text-foreground mb-4 border-b border-border pb-2">Work Experience</h2>
          <div class="space-y-6">
            <div *ngFor="let work of application.candidateProfile?.profile?.work">
              <h3 class="text-lg font-semibold text-primary">{{ work.position }}</h3>
              <p class="font-medium text-foreground">{{ work.name }}</p>
              <p class="text-sm text-muted-foreground">{{ work.startDate | date:'MMMM y' }} - {{ work.endDate ? (work.endDate | date:'MMMM y') : 'Present' }}</p>
              <p class="mt-2 text-muted-foreground whitespace-pre-line">{{ work.summary }}</p>
            </div>
          </div>
        </div>

        <!-- Education -->
        <div *ngIf="application.candidateProfile?.profile?.education?.length">
          <h2 class="text-2xl font-semibold text-foreground mb-4 border-b border-border pb-2">Education</h2>
          <div class="space-y-6">
            <div *ngFor="let edu of application.candidateProfile?.profile?.education">
              <h3 class="text-lg font-semibold text-primary">{{ edu.institution }}</h3>
              <p class="font-medium text-foreground">{{ edu.studyType }} in {{ edu.area }}</p>
              <p class="text-sm text-muted-foreground">{{ edu.startDate | date:'y' }} - {{ edu.endDate ? (edu.endDate | date:'y') : 'Present' }}</p>
            </div>
          </div>
        </div>

        <!-- Skills -->
        <div *ngIf="application.candidateProfile?.profile?.skills?.length">
          <h2 class="text-2xl font-semibold text-foreground mb-4 border-b border-border pb-2">Skills</h2>
          <div class="flex flex-wrap gap-2">
            <span *ngFor="let skill of application.candidateProfile?.profile?.skills" class="px-3 py-1 text-sm font-medium text-primary-foreground bg-primary/80 rounded-full">
              {{ skill.name }}
            </span>
          </div>
        </div>

        <!-- Projects -->
        <div *ngIf="application.candidateProfile?.profile?.projects?.length">
          <h2 class="text-2xl font-semibold text-foreground mb-4 border-b border-border pb-2">Projects</h2>
          <div class="space-y-6">
            <div *ngFor="let project of application.candidateProfile?.profile?.projects">
              <h3 class="text-lg font-semibold text-primary">{{ project.name }}</h3>
              <p class="text-sm text-muted-foreground">{{ project.startDate | date:'MMMM y' }} - {{ project.endDate ? (project.endDate | date:'MMMM y') : 'Present' }}</p>
              <p class="mt-2 text-muted-foreground whitespace-pre-line">{{ project.description }}</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<app-state-transition-modal
  [isVisible]="isAdvanceModalVisible"
  [currentState]="application?.status ?? ''"
  [possibleNextStates]="possibleNextStates"
  (closeModal)="isAdvanceModalVisible = false"
  (stateChange)="handleStateChange($event)"
></app-state-transition-modal>